# 统一修复计划（UNIFIED_PLAN）

## 目标

- 替代导入后手工修复的工作，自动完成格式整理、标点规范、繁简转换、引号统一与断行合并
- 分级管控修改风险，保证零误伤优先；逐步引入 AI 辅助完成高风险改动

## 核心痛点

- 格式混乱：标题空格、列表缩进、代码块与空行不规范
- 标点错乱：中文语境使用英文标点，英文语境使用中文标点
- 中英文空格：中英文之间缺少或多余空格
- 繁简转换：繁体转简体（OpenCC）
- 断行合并：段内不应出现的人工断行
- 引号统一：各类引号统一为中文双引号（U+201C/U+201D），保护代码片段

## 修复分级与策略

- SAFE：默认安全、低风险自动修复（格式、空格、混用标点等）
- SUGGESTED：建议修复，可能影响排版（断行合并、部分引号统一等）
- WARNING：需人工或 AI 辅助处理的高风险改动（复杂结构、含歧义上下文）

## 前端工作流

- 检查 → 计划 → 预览 → 应用 → 对比 → 导出
- 支持按板块（以 `#`/`##` 标题划分）生成与应用修复计划
- 预览支持行级与字词级两种差异高亮

## 后端接口

- POST `/api/analyze`：返回问题分组与结构大纲
- POST `/api/plan`：按选择的优先级与范围生成修复计划（全局或板块）
- POST `/api/preview-fixes`：返回原片段与处理后片段，用于差异预览
- POST `/api/apply-fixes`：应用计划并返回结果与处理报告

## 计划请求示例

```json
{
  "content": "# 标题\n段落...",
  "plan": {
    "selectedPriorities": ["SAFE", "SUGGESTED"],
    "sectionRange": { "start": 10, "end": 42 }
  }
}
```

## 验证与度量

- 修改统计：`modifiedLines`、`charactersDiff`、词/字数
- 可视化对比：原文/处理后并排，支持行级或字词级
- 误伤控制：SAFE 优先，SUGGESTED 预览后再应用

## 版本架构与模式切换

- 版本划分：
  - 基础版（Basic）：当前版本，聚焦格式/标点/空格/繁简/断行/引号等规则化处理
  - AI 专家版（Expert）：高阶文本修复（如错别字、语气、人物关系一致性、语法与风格）
- 模式切换要求：
  - 开关机制：两者互斥，不能同时运行；提供显式模式开关
  - 处理对象：优先对“基础版已处理后的内容”进行 AI 专家处理；也可在未完全基础处理时，仅执行高阶校对（如错别字），与基础任务隔离
  - 无干扰原则：AI 专家版对错别字/语气/人物关系等高阶项单独执行，不影响基础版的格式与结构任务
  - 入口建议：在基础版的“修复完成”或“修复计划”界面，提供“提交到 AI 专家处理”的入口；保留“下载后再上传”作为保底路径

## 界面与模式（实现回溯）

- 总览页：仅两张模式卡片（基础/专家）与项目呼号；进入模式后仅保留“返回总览”按钮
- 基础版 UI：左侧（导入/导出、检查与建议、一键修复、修复选项、基础设置），右侧（编辑/预览/对比）
- 专家版 UI：左侧（导入/导出、专家规则、提交专家处理、查找替换），右侧（编辑/预览/对比）
- 模式显隐控制：`updateModeView()` 专职显隐；`updateControlState()` 专职启停；模式状态 `mdCleanerUiMode`
- 返回总览弹窗：三选项“保存并返回/直接返回/取消”，并在保存时显示“请稍候，内容正在保存中……”；草稿键名 `mdCleanerDraft_basic`、`mdCleanerDraft_expert`
- 布局保障：移除 `mainContent` 内联样式，使用 CSS 网格（340px+1fr；窄屏 280px+1fr）确保左右两列

## AI 供应商策略与配置

- 主供应商：Gemini（作为首选模型），同时预留其他厂商（如 OpenAI、Azure OpenAI、Claude）接口能力
- 抽象层：统一 Provider 接口，前端只关心“专家版模式”与“规则设定”，后端按 Provider 路由调用
- 配置项建议：

```json
{
  "provider": "gemini",
  "model": "gemini-1.5-pro",
  "apiBase": "https://generativelanguage.googleapis.com",
  "apiKeyEnv": "GEMINI_API_KEY",
  "fallback": ["openai:gpt-4o", "azure-openai:gpt-4o-mini"]
}
```

- 安全要求：密钥只读自环境变量，禁止写入代码仓库；日志不输出明文密钥

## 专家版交互与规则设定（对话式）

- 规则设定窗口：提供独立交互面板，用户以对话方式指定“修复什么？如何修复？”
- 能力分层：
  - 必选：错别字纠错（首要目标）
  - 可选：重复词、重复标点、语法与风格建议、术语统一、人物关系一致性
- 模式隔离：
  - 基础版完成后可“一键提交到专家处理”（同一份内容），也可在未完成基础处理时仅执行错别字/语气等高阶校对
  - 专家版输出独立报告，不直接改动基础版的结构化修复结果，避免互相干扰
- 提示词（Prompt）管理：可保存/加载模板，支持参数化（风格、术语表、领域词典）

## 审查与合规策略

- 禁止内容审核：专家版规则设定明确不进行内容审核/过滤，仅执行文本修复与校对
- 合规与隐私：
  - 严禁上传敏感密钥与私密信息到模型端；必要时做局部打码
  - 对外调用只发送必要文本片段与上下文，不携带用户隐私元数据

## AI 集成路线（高阶修复）

- 第1阶段：基础高阶校对能力（错别字、重复词、重复标点）
- 第2阶段：语法与风格建议（句式优化、术语统一、读者语气一致性）
- 第3阶段：角色/人物关系一致性与上下文连贯性检查（人机协同、板块化应用）

## 当前实现状态（阶段性）

- 后端预备接口：`POST /api/ai/suggest`（基础规则：重复标点、重复词），已具备但前端未启用入口
- 前端入口：当前撤销“AI 建议”按钮，等待模式开关与专家版流程设计后再启用
 - 模式切换：已实现总览页与显隐/启停的集中控制；返回总览草稿保存生效；左右布局在窄屏保留两列

## 使用建议

- 优先应用 SAFE，逐块审阅后再应用 SUGGESTED
- 对复杂或含歧义文本先生成预览，再决定是否应用
- 导出前在对比视图确认关键段落无误伤