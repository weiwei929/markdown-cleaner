# 统一规划：文档检查与整理工具（AI 优先，2025-11）

## 愿景与适用场景
- 面向结构相对简单的纯文本/小说类 Markdown 文档
- 以“结构化检查 → 分板块修复 → 可视化确认 → 导出”为核心流程
- 明确以 AI 融合为最终目标，所有基础能力为 AI 接入与落地打牢地基

## 当前进展（已完成）
- 自动检查与摘要弹窗（总问题、分级统计、结构大纲、分板块统计）
- 仅识别行首 `#`/`##` 作为标题；取消“标题空格”提示，符合约束
- 分板块视图与导航（跳转板块起始/末尾）
- 修复计划弹窗：
  - 生成板块/全局修复计划（仅估算，不落地）
  - 仅应用 SAFE 到该板块；SUGGESTED 需确认
  - 导出修复计划 JSON
- 空格修复逐行化，保留 CRLF/LF；断行合并排除标题/分割线
- 问题项颜色与图标：安全（✅/绿色）、建议（⚠️/橙色）、警告（❌/红色）

## AI 优先目标
1. 高风险修复建议（警告/复杂建议项）由 AI 给出结构化说明、风险评级与替代方案
2. 文本级智能检查（错别字、语义不顺、术语统一），与规则检查互补
3. AI 计划生成与审阅：输出修复计划 JSON 与差异预览片段，人工确认后再执行
4. 多厂商适配与配置（basic/expert 模式，`AI_VENDOR`/`AI_API_KEY`/`AI_MODE`）

## 技术架构（AI Ready）
- 后端（Node.js + Express）：
  - Analyzer：结构检查/规则检测
  - Fixer：按计划/板块执行修复
  - Pipeline：计划生成与执行编排
  - AI Provider 适配：OpenAI/Claude/本地 LLM，通过统一接口
  - 接口：`/api/analyze`、`/api/plan`、`/api/apply-fixes`、`/api/ai-assist`（预留）
- 前端（原生 JS + HTML + CSS）：
  - 摘要弹窗、分板块视图、修复计划弹窗、导出弹窗
  - 结构回退解析（前端兜底），后端稳定后优先采用后端结构
- 配置与安全：
  - `.env` 管理：`PORT`、`AI_VENDOR`、`AI_API_KEY`、`AI_MODEL`、`AI_ENABLE`、`AI_MODE`
  - 无 CDN 依赖；生产开启预览安全策略

## 分阶段里程碑（AI 导向）
### Phase F0（地基，已完成）
- 自动检查与摘要弹窗
- 结构大纲与分板块统计（仅 `#`/`##`）
- 板块修复计划生成（SAFE/SUGGESTED 估算）
- 板块执行：仅 SAFE；SUGGESTED 需确认
- 修复计划 JSON 导出
- 空格修复逐行化 + 断行合并块级排除

### Phase F1（结构与管线，进行中）
- 统一问题项渲染模板（类型类名 + 图标 + 文案）
- 全局修复计划生成与导出
- 差异预览：计划弹窗中展示“修复前/修复后”片段（按板块）
- 板块导航：跳转下一/上一板块，快捷键支持

### Phase F2（可观察性与编辑器增强）
- 可选切换 CodeMirror：高亮问题（`markText`）、点击弹出修复菜单
- 查找替换与跳转到行整合；长文本性能优化

### Phase F3（AI 集成与适配）
- 后端 `AI Provider` 适配层与 `/api/ai-assist` 接口
- 基础版：说明与风险提示；专家版：结构化建议与示例改写
- 批量/速率控制与缓存策略；计划 JSON 注入 AI 建议

### Phase F4（质量与发布）
- 计划快照与回滚（撤销/重做）
- 检查报告导出（总览/分板块/示例）
- 文档与开关配置完善；发布说明

## 实施清单（模块维度）
- Analyzer：边界增强（表格/HTML/引用嵌套）；结构容错
- Fixer：差异预览片段生成；计划快照/回滚
- 前端：模板统一；差异预览与确认流程；导航与快捷键
- 配置：`.env` 开关（CodeMirror/AI）；多厂商 Key 管理
- AI：Provider 抽象与 Prompt 设计；缓存与并发控制

## 验收标准（AI Ready）
- 流程：导入 → 自动检查 → 分板块修复计划 → 差异预览/确认 → 导出
- 稳定：标题/分割线/换行不误合并；大纲/板块定位准确
- 可视：颜色/图标清晰；差异预览易读；AI 建议结构化
- 可控：SUGGESTED 默认需确认；WARNING 仅提示；可回滚
- 可交付：计划与报告可导出；AI 模式可配置

## 风险与缓解
- 误合并：断行合并严格排除块级元素；差异预览 + 回滚
- 大文件：板块分页与懒加载；并发与缓存控制
- 兼容性：无 CDN 依赖；FilePicker 不可用时回退下载
- AI：速率/成本控制；离线兜底

## 维护与发布
- 本文件取代 `LINTER_ENHANCEMENT_PLAN.md` 与 `OPTIMIZATION_PLAN.md`
- 开发顺序：F1 → F2 → F3 → F4，确保 AI 接入前基础扎实
- 变更同步：所有改动需更新本文件