- **🔤 引号统一** - 将各类引号统一为中文双引号（U+201C/U+201D）
- **🈚 繁简转换** - 将繁体中文自动转换为简体中文
- **🛠️ 手动微调** - 支持实时编辑器内手动调整修复结果
- **👁️ 实时预览** - 提供 Markdown 渲染效果的实时预览 *（注：引号显示可能有差异）*
- **⚖️ 对比视图** - 修复前后内容对比，清晰看到所有变更
- **💾 文件下载** - 正确保存处理后的文档，保持所有格式修复

## 🎯 项目目标与核心痛点

- 目标：替代手工修复，自动完成格式整理、标点规范、繁简转换、引号统一与断行合并；后续引入 AI 辅助处理高风险改动
- 痛点：
  - 格式混乱（标题空格、列表缩进、代码块与空行不规范）
  - 标点错乱（中文语境英文标点、英文语境中文标点）
  - 中英文空格（中英文之间缺少或多余空格）
  - 繁简转换（繁体统一为简体）
  - 断行合并（段内不应断开的内容自动合并）
- 引号统一（各类引号统一为中文双引号，保护代码片段）

详见变更日志：`CHANGELOG.md`

### 🤖 AI 专家版（规划中）
- 目的：更高阶文本修复（错别字、重复词、语法与风格、人物关系一致性等）
- 模式：与基础版互斥的独立模式，通过开关进入；优先对基础版处理后的内容执行
- 接入：后端预备接口 `/api/ai/suggest` 已提供（基础规则），前端入口暂未启用，待模式与流程定稿

#### 供应商策略
- 主供应商：Gemini（优先使用），预留 OpenAI/Azure OpenAI/Claude 等可插拔能力
- 配置读取自环境变量（如 `GEMINI_API_KEY`），不在仓库写入密钥

#### 规则与提示词交互
- 专家版提供“规则设定”窗口，用户以对话指定“修复什么？如何修复？”
- 必选能力：错别字纠错；可选能力：重复词/重复标点/语法风格/术语统一/人物关系一致性
- 禁止内容审核：专家版仅执行文本修复与校对，不做内容审查

## 🧭 界面与模式架构

- 总览页：启动后仅显示项目呼号与两张模式卡片（基础版/AI 专家版），点击进入对应模式；模式内仅保留“返回总览”
- 基础版 UI：左侧为文件导入/导出、检查与建议、一键修复、修复选项、基础设置（快捷键默认禁用）；右侧为编辑/预览/对比
- 专家版 UI：左侧为文件导入/导出、专家规则、提交专家处理、查找替换（替换全部/逐个替换）；右侧为编辑/预览/对比
- 返回总览：弹窗强提示“保存并返回/直接返回/取消”；选择“保存并返回”时写入 localStorage 草稿并提示“请稍候，内容正在保存中……”
- 草稿键名：`mdCleanerDraft_basic`、`mdCleanerDraft_expert`；模式状态键：`mdCleanerUiMode`
- 布局保证：CSS 使用 `.main-content { display: grid; grid-template-columns: 340px 1fr }`，并在窄屏保持两列（280px + 1fr）

## 📝 变更日志

详细变更记录请查看：`CHANGELOG.md`

**最新版本：** v1.3.0 (2025-12-25)
- ✨ 异体字转换：支持 10 个常见异体字自动转换
- 🔒 文件上传安全：5MB 大小限制 + 格式验证
- 📊 行号显示：编辑器左侧显示行号，方便定位
- 🐛 Bug 修复：修复模态框关闭、标题格式化、列表合并等问题
- 🎨 UI 优化：侧边栏宽度、字体大小、行高优化

## 🚀 快速开始

### 本地运行

1. 克隆项目：
```bash
git clone https://github.com/weiwei929/markdown-cleaner.git
cd markdown-cleaner
```

2. 安装依赖：
```bash
npm install
```

3. 配置环境变量（可选）：
```bash
# 复制示例文件
cp .env.example .env

# 编辑 .env 文件，配置必要的环境变量
# 生产环境必须配置 CORS_ORIGINS
```

4. 启动服务：
```bash
npm start
```

### 访问应用

打开浏览器访问：`http://localhost:3000`

### 生产环境部署

**重要配置：**
- 必须设置 `NODE_ENV=production`
- 必须配置 `CORS_ORIGINS`（允许的域名，逗号分隔）
- 建议配置 API 限流参数（`RATE_LIMIT_*`）
- 可选配置 `GEMINI_API_KEY`（启用 AI 专家版功能）

**环境变量说明：**
```env
# 必需（生产环境）
NODE_ENV=production
CORS_ORIGINS=https://your-domain.com

# 可选（有默认值）
PORT=3000
RATE_LIMIT_WINDOW_MS=900000
RATE_LIMIT_MAX_REQUESTS=100
STRICT_RATE_LIMIT_WINDOW_MS=60000
STRICT_RATE_LIMIT_MAX_REQUESTS=10
GEMINI_API_KEY=your_key_here
```

## 📖 使用说明

### 1. 上传文件
- 点击上传区域选择文件，或直接拖拽文件到上传区域
- 支持 `.md`、`.markdown`、`.txt` 格式
- 文件大小限制：5MB

### 2. 选择处理选项
- **格式修复**：修复标题、列表、代码块等格式问题
- **标点规范**：规范中英文标点符号使用
- **繁简转换**：将繁体中文转为简体中文（包含异体字转换）
- **合并断行**：智能合并段落中的断行，保留 Markdown 结构

### 3. 处理文档
- 点击"⚡ 一键修复"开始自动处理
- 处理完成后会显示对比视图

### 4. 手动微调
- 在编辑器中可以手动调整处理结果
- 支持实时预览 Markdown 渲染效果
- 可随时重置到原始内容

### 5. 下载结果
- 点击"💾 下载文件"保存处理后的文档
- 文件名会自动添加 `_cleaned` 后缀
- **下载的文件包含所有正确的格式修复，包括中文引号**

## 🔧 处理规则

### 格式修复规则

**标题格式**
- 确保标题标记（`#`）后有空格
- 标题前后添加适当的空行

**列表格式**
- 统一列表标记格式（`-` 用于无序列表）
- 修复列表项与标记之间的空格
- 规范嵌套列表的缩进（每级2个空格）

**代码块格式**
- 确保代码块前后有空行
- 修复行内代码的反引号格式

### 标点规范规则

**智能标点处理**
- 中文语境：使用中文标点（，。！？：；）
- 英文语境：使用英文标点（,.!?:;）
- 中英文混合：根据上下文智能选择

**引号统一处理**
- 英文引号：`"` `"` `"` → 中文引号 `"` `"`
- 繁体引号：`「` `」` → 中文引号 `"` `"`
- 书名号：`『` `』` → 中文引号 `"` `"`
- 其他引号：`‚` `„` `«` `»` `‹` `›` → 中文引号 `"` `"`

**空格处理**
- 中英文字符间自动添加空格
- 清理多余的空格
- 标点符号与文字间的空格规范

### 繁简转换规则

**常见转换**
- 資料 → 资料
- 網路 → 网络
- 討論 → 讨论
- 問題 → 问题
- 檔案 → 文件

**异体字转换**（新增）
- 勐 → 猛、幺 → 么、麽 → 么
- 豔 → 艳、洩 → 泄、週 → 周
- 裡 → 里、髮 → 发、乾 → 干、為 → 为

### 引号统一规则

**处理前示例**
```
这是"英文引号"和「繁体引号」还有『书名号』的混用。
```

**处理后示例**
```
这是"英文引号"和"繁体引号"还有"书名号"的统一。
```

**Unicode 编码**
- 左引号：`"` (U+201C, Unicode 8220)
- 右引号：`"` (U+201D, Unicode 8221)

## 📁 项目结构

```
markdown-cleaner/
├── server.js                 # Express 服务器（含安全中间件）
├── package.json             # 项目配置
├── .env.example             # 环境变量配置模板
├── utils/
│   └── textProcessor.js     # 文本处理核心模块
├── src/
│   └── domain/              # 业务逻辑层
│       ├── analyzer.js      # 规则分析器
│       ├── fixer.js         # 修复应用器
│       └── ai.js            # AI 专家系统
├── public/                  # 前端资源
│   ├── index.html          # 主页面
│   ├── css/
│   │   └── style-new.css   # 样式文件（CSS 变量系统）
│   └── js/
│       ├── main.js         # ES Module 入口
│       └── modules/        # 模块化代码
│           ├── Core/      # 核心模块（App, State）
│           ├── UI/         # UI 管理（UIManager, ModalManager, EditorManager）
│           ├── Features/   # 功能模块（FileHandler, BasicCleaner, ExpertSystem）
│           └── Utils/      # 工具模块（API）
└── docs/                   # 文档目录
    ├── ARCHITECTURE_DIAGRAM.md  # 架构图
    └── ENGINEERING_STANDARDS.md # 工程规范
```

## 🧪 测试

### 测试样例

项目中包含多个测试文件，你可以用它们来测试工具的各项功能：

- **`test-document.md`** - 综合测试：格式问题、标点问题、繁体字、各种 Markdown 语法
- **`test-article.md`** - 文章测试：标点符号、引号、格式问题
- **`test-line-break.md`** - 断行测试：断行合并功能测试

### 测试指南

**基础版测试：**
1. 启动服务器：`npm start`
2. 访问：`http://localhost:3000`
3. 上传测试文件
4. 点击"检查与建议"查看问题
5. 点击"一键修复"处理文档
6. 查看对比视图确认修改
7. 导出文件验证结果

**AI 专家版测试（需要 API Key）：**
1. 配置 `GEMINI_API_KEY` 环境变量
2. 进入 AI 专家版
3. 设置专家规则
4. 提交专家处理
5. 查看 AI 分析结果

**安全功能测试：**
- 验证 CORS 配置（生产环境）
- 测试 API 限流（快速发送多个请求）
- 检查 Request ID（查看响应头）
- 验证错误响应格式

## 🔍 API 接口

### POST `/api/process-text`
处理文本内容

**请求体：**
```json
{
  "content": "Markdown文本内容",
  "options": {
    "fixFormat": true,
    "fixPunctuation": true,
    "convertTraditional": true
  }
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "originalContent": "原始内容",
    "processedContent": "处理后内容",
    "report": {
      "originalStats": { "characters": 1000, "lines": 50, "words": 200 },
      "processedStats": { "characters": 1020, "lines": 52, "words": 200 },
      "changes": { "modifiedLines": 5, "charactersDiff": 20 }
    }
  }
}
```

### GET `/api/info`
获取应用信息

### GET `/api/health`
健康检查

## 🛠️ 技术栈

- **后端**: Node.js + Express
- **前端**: 原生 JavaScript + HTML5 + CSS3
- **文本处理**: 正则表达式 + Unicode 编码 + OpenCC.js
- **Markdown 解析**: Marked.js
- **引号处理**: 基于 Unicode 字符编码的精确替换

## 🎯 项目状态

### ✅ 已完成功能
- **核心处理功能**：格式修复、标点规范、引号统一、繁简转换
- **用户界面**：文件上传、实时编辑器、对比视图
- **手动微调**：支持编辑器内容手动调整
- **文件下载**：正确保存所有处理结果

### ⚠️ 已知问题
- **预览功能**：由于 `marked.js` 的引号处理机制，预览中的引号显示可能与编辑器不一致
- **影响范围**：仅影响预览显示，不影响实际文档处理和下载结果
- **解决方案**：下载的文件包含正确的中文引号，可以正常使用

### 📊 功能完整度
- 🟢 **文档处理**：100% 完成
- 🟢 **文件操作**：100% 完成  
- 🟢 **手动编辑**：100% 完成
- � **预览显示**：95% 完成（引号显示问题）

## �📝 开发说明

### 添加新的处理规则

1. 在 `utils/textProcessor.js` 中添加新的处理方法
2. 在 `processText` 方法中调用新的处理逻辑
3. 更新前端选项界面（如需要）

### 引号处理机制

引号统一使用基于 Unicode 编码的精确替换：
```javascript
// 左引号：Unicode 8220
const leftQuote = String.fromCharCode(8220);  // "
// 右引号：Unicode 8221  
const rightQuote = String.fromCharCode(8221); // "
```

### 自定义样式

修改 `public/css/style-new.css` 中的样式定义。项目使用 CSS 变量系统，支持模式切换（基础版/专家版/总览）。

### 环境变量配置

参考 `.env.example` 文件，配置必要的环境变量：
- **开发环境**：通常只需要 `PORT` 和 `NODE_ENV=development`
- **生产环境**：必须配置 `CORS_ORIGINS` 和 `NODE_ENV=production`

### 扩展功能

- 可以集成更多的 Markdown 处理库
- 添加更多的文本处理规则
- 支持批量处理功能
- 添加处理历史记录
- 修复预览功能的引号显示问题
- 实现 Navigation 的跳转功能

## 🤝 贡献

欢迎提交 Issue 和 Pull Request 来改进这个工具！

## 📄 许可证

MIT License

---

**享受整洁的 Markdown 文档！** 📝✨